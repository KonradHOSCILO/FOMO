{% load static %}
<!DOCTYPE html>
<html lang="pl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>FOMO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'todo/styles.css' %}">
</head>
<body>
<div class="microsoft-todo-layout">
    <!-- Top Header Bar -->
    <header class="top-header">
        <div class="header-left">
            <h1 class="app-title">FOMO</h1>
        </div>
        <nav class="header-tabs">
            <a href="?view=today" class="tab {% if active_view == 'today' %}active{% endif %}">Dzisiaj</a>
            <span class="tab-divider">|</span>
            <a href="?view=tomorrow" class="tab {% if active_view == 'tomorrow' %}active{% endif %}">Jutro</a>
            <span class="tab-divider">|</span>
            <a href="?view=week" class="tab {% if active_view == 'week' %}active{% endif %}">tydzień</a>
            <span class="tab-divider">|</span>
            <a href="?view=month" class="tab {% if active_view == 'month' %}active{% endif %}">Miesiąc</a>
        </nav>
    </header>

    <div class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-groups" data-group-list>
                <a href="?view={{ active_view }}" class="sidebar-group-btn sidebar-group-btn--all {% if not active_group %}active{% endif %}">
                    Wszystkie
                </a>
                {% for group in groups %}
                    <div class="sidebar-group-wrapper" 
                         data-group-id="{{ group.id }}"
                         data-group-order="{{ group.order }}"
                         draggable="true">
                        <div class="group-drag-handle" title="Przeciągnij, aby zmienić kolejność">⋮⋮</div>
                        <button class="sidebar-group-btn {% if active_group == group.id %}active{% endif %}" 
                                data-group-id="{{ group.id }}">
                            <span class="group-color-indicator" style="background-color: {{ group.color }}"></span>
                            {{ group.name }}
                        </button>
                        <button type="button" class="group-menu-btn" data-toggle-group-menu="{{ group.id }}" title="Opcje grupy">⋮</button>
                        <div class="group-menu-dropdown" data-group-menu="{{ group.id }}">
                            <button type="button" class="group-menu-item" data-edit-group="{{ group.id }}">Edytuj kolor</button>
                            {% if group.name not in default_group_names %}
                                <form method="post" action="{% url 'delete_group' group.id %}" class="group-menu-form">
                                    {% csrf_token %}
                                    <button type="submit" class="group-menu-item danger">Usuń grupę</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <button class="sidebar-group-btn">Ważne</button>
                    <button class="sidebar-group-btn">Powtarzalne</button>
                    <button class="sidebar-group-btn">Sprzątanie</button>
                {% endfor %}
            </div>

            <button class="sidebar-button add-group-btn" type="button" data-open-group-form>
                + Dodaj grupę
            </button>
        </aside>

        <!-- Main Content Area -->
        <main class="content-area">
            <!-- New Task Input -->
            <div class="task-input-container visible" data-task-input-container>
                <form method="post" class="task-input-form" data-task-form>
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_task">
                    <div class="task-input-row">
                        <input type="text" 
                               name="task-title" 
                               class="task-input" 
                               placeholder="Nowe zadanie..." 
                               autocomplete="off"
                               data-task-title-input>
                        <button type="submit" class="task-submit-btn" title="Dodaj zadanie">✓</button>
                    </div>
                    <textarea name="task-description" 
                              class="task-description-input" 
                              placeholder="Opis zadania (opcjonalnie)" 
                              rows="2"
                              data-task-description-input></textarea>
                    
                    <!-- Repeat Options and Group Selection - shown under input -->
                    <div class="task-options-row">
                        <div class="repeat-options" data-repeat-options>
                            <span class="repeat-label">powtarzanie:</span>
                            <label class="repeat-option">
                                <input type="radio" name="repeat_frequency" value="none" checked>
                                <span>Brak</span>
                            </label>
                            <label class="repeat-option">
                                <input type="radio" name="repeat_frequency" value="daily">
                                <span>Dziennie</span>
                            </label>
                            <label class="repeat-option">
                                <input type="radio" name="repeat_frequency" value="weekly">
                                <span>Tygodniowo</span>
                            </label>
                            <label class="repeat-option">
                                <input type="radio" name="repeat_frequency" value="monthly">
                                <span>Miesięcznie</span>
                            </label>
                            <label class="repeat-option">
                                <input type="radio" name="repeat_frequency" value="yearly">
                                <span>Rocznie</span>
                            </label>
                        </div>
                        <div class="group-selector">
                            <button type="button" class="group-selector-btn" data-toggle-group-dropdown>
                                <span class="group-selector-label">Grupa:</span>
                                <span class="group-selector-value" data-selected-group-name>Brak</span>
                                <span class="group-selector-arrow">▾</span>
                            </button>
                            <div class="group-selector-dropdown" data-group-selector-dropdown>
                                <button type="button" class="group-selector-option" data-group-id="" data-group-name="Brak">
                                    Brak
                                </button>
                                {% for group in groups %}
                                    <button type="button" class="group-selector-option" data-group-id="{{ group.id }}" data-group-name="{{ group.name }}">
                                        {{ group.name }}
                                    </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields for form submission -->
                    <input type="hidden" name="task-repeat_frequency" value="none" id="id_task_repeat_frequency">
                    <input type="hidden" name="task-group" value="" id="id_task_group">
                    <input type="hidden" name="task-description" value="" id="id_task_description">
                </form>
            </div>

            <!-- Task Lists - COMPLETELY REWRITTEN -->
            <div class="task-lists" data-task-list>
                {% for task in tasks %}
                    <div class="task-item" 
                         data-task-id="{{ task.id }}" 
                         data-task-group="{{ task.group_id|default:'' }}"
                         data-task-position="{{ task.position }}"
                         draggable="true">
                        <div class="task-drag-handle" title="Przeciągnij, aby zmienić kolejność">⋮⋮</div>
                        <form method="post" action="{% url 'toggle_task' task.id %}" class="task-toggle-form">
                            {% csrf_token %}
                            <input type="checkbox" 
                                   class="task-checkbox" 
                                   {% if task.is_completed %}checked{% endif %}
                                   onchange="this.form.submit()">
                        </form>
                        <div class="task-content">
                            <span class="task-text {% if task.is_completed %}completed{% endif %}">{{ task.title }}</span>
                            {% if task.description %}
                                <span class="task-description">{{ task.description }}</span>
                            {% endif %}
                        </div>
                        {% if task.group %}
                            <span class="task-group-badge" style="background-color: {{ task.group.color }}20; color: {{ task.group.color }};">
                                {{ task.group.name }}
                            </span>
                        {% endif %}
                        <div class="task-actions">
                            <button type="button" class="task-edit" data-edit-task="{{ task.id }}" title="Edytuj">✎</button>
                            <form method="post" action="{% url 'delete_task' task.id %}" class="task-delete-form">
                                {% csrf_token %}
                                <button type="submit" class="task-delete" title="Usuń">✕</button>
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-state">
                        <p>Brak zadań do wyświetlenia</p>
                        <small>Dodaj nowe zadanie powyżej</small>
                    </div>
                {% endfor %}
            </div>
        </main>
    </div>

    <!-- Add Group Modal -->
    <div class="modal" data-modal="group-modal" aria-hidden="true">
        <div class="modal-backdrop" data-close-modal></div>
        <div class="modal-content">
            <header class="modal-header">
                <h2>Dodaj grupę</h2>
                <button class="modal-close" type="button" data-close-modal>&times;</button>
            </header>
            <form method="post" class="modal-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_group">
                {% for field in group_form %}
                    <label class="form-field">
                        <span>{{ field.label }}</span>
                        {{ field }}
                        {% if field.errors %}
                            <small class="form-errors">{{ field.errors|striptags }}</small>
                        {% endif %}
                    </label>
                {% endfor %}
                <footer class="form-actions">
                    <button class="btn primary" type="submit">Dodaj</button>
                    <button class="btn ghost" type="button" data-close-modal>Anuluj</button>
                </footer>
            </form>
        </div>
    </div>

    <!-- Task Edit Modal (loaded dynamically) -->
    <div id="task-edit-modal-container"></div>
</div>
<script src="{% static 'todo/dashboard.js' %}" defer></script>
</body>
</html>
